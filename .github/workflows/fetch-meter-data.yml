name: Fetch Meter Data

on:
  schedule:
    # Executa a cada hora (0 minutos de cada hora)
    - cron: '0 * * * *'
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fetch Meter Data
      run: |
        echo "üöÄ Iniciando coleta de dados dos medidores..."
        
        # Fazer requisi√ß√£o para a API da Vercel
        response=$(curl -s -w "%{http_code}" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          -H "Content-Type: application/json" \
          -X GET \
          "${{ secrets.VERCEL_APP_URL }}/api/cron/fetch-meter-data")
        
        # Extrair c√≥digo de status HTTP
        http_code="${response: -3}"
        response_body="${response%???}"
        
        echo "üìä C√≥digo de resposta: $http_code"
        echo "üìã Resposta: $response_body"
        
        # Verificar se a requisi√ß√£o foi bem-sucedida
        if [ "$http_code" -eq 200 ]; then
          echo "‚úÖ Coleta de dados executada com sucesso!"
        else
          echo "‚ùå Erro na coleta de dados. C√≥digo: $http_code"
          echo "Resposta: $response_body"
          exit 1
        fi
        
    - name: Log Execution Time
      run: |
        echo "‚è∞ Execu√ß√£o finalizada em: $(date)"
