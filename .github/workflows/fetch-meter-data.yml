name: Fetch Meter Data

on:
  schedule:
    # Executa a cada hora (0 minutos de cada hora)
    - cron: '0 * * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate Environment Variables
      run: |
        echo "ğŸ” Validando variÃ¡veis de ambiente..."
        
        if [ -z "${{ secrets.VERCEL_URL }}" ]; then
          echo "âŒ VERCEL_URL nÃ£o estÃ¡ configurado"
          exit 1
        fi
        
        if [ -z "${{ secrets.CRON_SECRET }}" ]; then
          echo "âŒ CRON_SECRET nÃ£o estÃ¡ configurado"
          exit 1
        fi
        
        echo "âœ… VariÃ¡veis de ambiente validadas"
        echo "ğŸŒ URL: ${{ secrets.VERCEL_URL }}"
        
    - name: Test API Connectivity
      run: |
        echo "ğŸ”— Testando conectividade com a API..."
        
        # Testar se a API estÃ¡ respondendo
        status_code=$(curl -s -o /dev/null -w "%{http_code}" \
          --connect-timeout 10 \
          --max-time 30 \
          "${{ secrets.VERCEL_URL }}/api/debug")
        
        echo "ğŸ“Š Status da API debug: $status_code"
        
        if [ "$status_code" -eq 200 ]; then
          echo "âœ… API estÃ¡ respondendo"
        else
          echo "âš ï¸ API debug retornou: $status_code"
        fi
        
    - name: Fetch Meter Data
      id: fetch_data
      run: |
        echo "ğŸš€ Iniciando coleta de dados dos medidores..."
        
        # Configurar timeout e retry
        max_retries=3
        retry_count=0
        success=false
        
        while [ $retry_count -lt $max_retries ] && [ "$success" = false ]; do
          retry_count=$((retry_count + 1))
          echo "ğŸ”„ Tentativa $retry_count de $max_retries"
          
          # Fazer requisiÃ§Ã£o para a API da Vercel com timeout
          response=$(curl -s -w "\n%{http_code}" \
            --connect-timeout 15 \
            --max-time 60 \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "User-Agent: GitHub-Actions-Cron/1.0" \
            -X GET \
            "${{ secrets.VERCEL_URL }}/api/cron/fetch-meter-data" \
            || echo -e "\nERROR")
          
          # Separar resposta e cÃ³digo HTTP
          if echo "$response" | tail -1 | grep -q "ERROR"; then
            echo "âŒ Erro de conexÃ£o na tentativa $retry_count"
            http_code="ERROR"
            response_body="Erro de conexÃ£o"
          else
            http_code=$(echo "$response" | tail -1)
            response_body=$(echo "$response" | head -n -1)
          fi
          
          echo "ğŸ“Š CÃ³digo de resposta: $http_code"
          echo "ğŸ“‹ Resposta (primeiros 500 chars): ${response_body:0:500}"
          
          # Verificar se a requisiÃ§Ã£o foi bem-sucedida
          if [ "$http_code" = "200" ]; then
            echo "âœ… Coleta de dados executada com sucesso!"
            success=true
            
            # Tentar extrair informaÃ§Ãµes da resposta JSON
            if command -v jq >/dev/null 2>&1; then
              echo "$response_body" | jq -r '.message // "Sem mensagem"' 2>/dev/null || echo "Resposta nÃ£o Ã© JSON vÃ¡lido"
            fi
            
          elif [ "$http_code" = "401" ]; then
            echo "âŒ Erro de autorizaÃ§Ã£o (401). Verifique CRON_SECRET"
            exit 1
          elif [ "$http_code" = "404" ]; then
            echo "âŒ Endpoint nÃ£o encontrado (404). Verifique VERCEL_URL"
            exit 1
          else
            echo "âš ï¸ Erro na coleta de dados. CÃ³digo: $http_code"
            echo "Resposta completa: $response_body"
            
            if [ $retry_count -lt $max_retries ]; then
              echo "â³ Aguardando 30 segundos antes da prÃ³xima tentativa..."
              sleep 30
            fi
          fi
        done
        
        if [ "$success" = false ]; then
          echo "âŒ Falha apÃ³s $max_retries tentativas"
          exit 1
        fi
        
    - name: Log Execution Summary
      if: always()
      run: |
        echo "ğŸ“Š Resumo da ExecuÃ§Ã£o:"
        echo "â° HorÃ¡rio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸŒ Timezone: $(date '+%Z %z')"
        echo "ğŸ”§ Runner: ${{ runner.os }}"
        echo "ğŸ“ Workflow: ${{ github.workflow }}"
        echo "ğŸ”€ Ref: ${{ github.ref }}"
        
        if [ "${{ steps.fetch_data.outcome }}" = "success" ]; then
          echo "âœ… Status: Sucesso"
        else
          echo "âŒ Status: Falha"
        fi
        
    - name: Notify on Failure
      if: failure()
      run: |
        echo "ğŸš¨ ALERTA: Falha na coleta de dados dos medidores"
        echo "â° Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”— Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ğŸ“§ Considere verificar os logs e configuraÃ§Ãµes"
